# 车险多维分析系统

车险变动成本明细分析多维数据分析平台，提供车险业务核心指标的4×4 KPI看板展示和多维度分析功能。

## 部署架构

本项目已重构为**纯静态部署**架构，支持部署到任何静态托管服务（如 Vercel、Netlify、GitHub Pages 等）。

### 静态部署特性
- **纯客户端渲染**：所有数据处理和计算在浏览器端完成
- **无服务端依赖**：移除了所有 API 路由和服务端操作
- **静态文件导出**：使用 Next.js 静态导出功能生成纯 HTML/CSS/JS 文件
- **AI 功能说明**：AI 分析功能在静态部署模式下不可用，相关按钮会显示提示信息

### 构建和部署

```bash
# 安装依赖
npm install

# 开发模式
npm run dev

# 构建静态文件
npm run build

# 本地预览静态文件（可选）
npx serve out -p 3000
```

构建完成后，`out` 目录包含所有静态文件，可直接部署到任何静态托管服务。

## 功能特性

- **4×4 KPI看板矩阵**：展示16个核心车险业务指标，核心KPI与二级指标共享行级主题配色，并同步呈现环比变化幅度与绝对变化值（万元/pp）
- **智能数据导入**：支持CSV文件拖拽上传，自动验证数据格式
- **多维度筛选**：支持16个维度字段的灵活筛选（起保年度、周序号、客户类别、机构层级、三级机构、业务类型、险种类型、能源类型、险别组合、过户车、新续转状态、车险评级、高速风险等级、大货车评分、小货车评分、终端来源）
- **对比分析**：同比、环比及自定义时间段对比
- **响应式设计**：适配桌面、平板和移动设备
- **实时计算**：基于标准公式的动态指标计算
- **智能图表洞察**：
  - 占比图支持13个维度切换（客户类别、机构层级、三级机构、业务类型等），内/外环指标可自由组合
  - 周趋势组合图聚焦最近12周，柱状仅提供绝对值类指标、折线限定率值/占比指标，并沿用占比图的维度筛选体验
  - 条形对比图支持13个维度和15个指标的交叉分析，自动缩放极值
  - 费用结余图基于14%基准线展示各维度的费用优化潜力
  - 所有图表标题采用麦肯锡金字塔原理，自动生成核心观点，去除冗余筛选信息
- **分区呈现**：应用包含六大核心板块：**经营概览**（默认页，含 KPI 看板）、**趋势洞察**、**结构分析**、**对比分析**、**费用分析**和**设置**。顶部导航栏可实现板块间一键切换。周序号多选仅影响趋势洞察板块，其余图表默认取最新周数据。
- **经营概览强化**：每行卡片主题色随指标组切换，突出签单保费、满期赔付率、费用率、边际贡献率四大业务核心；核心指标默认高亮并保持与二级指标一致的视觉语言
- **图表数据视图**：经营概览、趋势洞察、结构分析、对比分析、费用分析五大板块在维度控制区新增“查看数据”开关，可切换表格视图并一键复制当前数据，AI 深度分析入口统一位于右上角便于快速调用
- **AI 问题归因升级**：自动对签单保费下降、满期赔付率和费用率恶化进行维度归因，提供“选择分析板块”入口预留模块化扩展能力
- **Apple 风格视觉**：引入 SF Pro 字体、半透明卡片与柔和渐变背景，延续苹果官网的极简高质感体验
- **数据导出**：支持CSV格式数据导出

> 详细 PRD 请见：`PRD.md`

## 设计系统蓝图

- **色彩语义体系**：
  - 状态色专用：红/黄/蓝/绿仅用于“满期边际贡献率”四区间映射，不用于其他装饰或背景，以避免语义冲突。
  - 通用强调：非状态的高亮/装饰统一采用紫系（violet/indigo/fuchsia）与中性灰系。
  - 背景采用柔和浅灰与玻璃态白面板（见下方 Panel Token），图表/标签控制在 6 色以内，兼顾色盲安全。
- **字体层级体系**：
  - H1/H2/H3 分别为 46/32/24 px，字重 600，正文（16 px）与辅助文字（14 px）保持 1.5 行距。
  - 关键 KPI 采用等宽数字字体呈现，确保读数稳定，主副信息间距 8–16 px。
- **倒金字塔信息层**：
  - KPI 卡片顶部聚焦 5 秒可读的核心指标（数值 + 对比箭头），中部以标签展示关键维度，底部由 AI 自动生成相关的静态分析文本，取代了旧的交互式下钻功能。
  - 颜色、字体、阴影及渐变均遵循统一语义，确保仪表板在响应式布局与浅/深色主题下保持一致体验。

### 视觉约束补充（本次变更）
- 统一面板底色：所有板块容器采用一致的玻璃态白面板（含边框与模糊）。
- 状态色保留：红/黄/蓝/绿仅用于满期边际贡献率状态色映射；其余 UI 不使用这四色及其渐变。
- 通用强调改用紫系与中性灰，避免与状态色语义冲突。

### Panel Surface Token（可配置）
- CSS 变量：`--panel-bg`、`--panel-border`（默认分别为 `rgba(255,255,255,0.8)`、`rgba(255,255,255,0.6)`；深色模式保持同样的玻璃态体验）。
- 工具类：`.panel-surface`（统一设置面板背景色与边框色）。
- 使用位置：看板容器、卡片、图表容器、抽屉/面板等通用壳层组件。

## 数据可视化规范
- 图表选择：趋势=折线图、占比=饼/环图、对比=柱图、相关性=散点图，避免 3D 和夸张装饰。
- 数据密度：遵循"数据墨水比"原则，自动聚合时间粒度，保持信息密度与可读性平衡。
- 异常标注：自动识别并高亮异常点，提示变化原因或业务解读。
- 动效准则：动效用于强调趋势与切换，保持节奏克制，不干扰阅读。

### 图表颜色规范
基于满期边际贡献率的颜色映射规则：
- **绿色系**：满期边际贡献率 > 12%，数值越大颜色越深
- **蓝色系**：满期边际贡献率 8%-12% 区间，数值越大颜色越深
- **黄色系**：满期边际贡献率 4%-8% 区间，数值越小颜色越深
- **红色系**：满期边际贡献率 < 4% 区间，数值越小颜色越深

### 图表排序规范
- 所有图表必须支持排序功能
- 提供从大到小和从小到大的排序切换
- 默认排序方式根据业务需求确定

### 数值显示规范
- **绝对值**：取整数显示（如保费金额、件数）
- **率值或占比**：保留两位小数（如赔付率、费用率）
- **自主系数**：保留三位小数

## 智能客户类别切片

为了提升分析效率和用户体验，系统引入了"智能客户类别切片"功能。此功能将复杂的多维度选项组合映射为简洁、易于理解的客户类别组合。该映射同时应用于动态标题生成和智能洞察（AI搜索）中。

### 当前客户类别组合规则 (可扩展)

| 客户类别组合 | 触发条件 (客户类别 `customer_category_3`) | AI 搜索关键词 |
| :--- | :--- | :--- |
| **私家车** | 仅选择“非营业个人客车” | `私家车` |
| **单位客车** | 选择“非营业企业客车”与/或“非营业机关客车” | `单位客车` |
| **非营客车组合** | 同时选择“非营业个人客车”、“非营业企业客车”、“非营业机关客车” | `非营客车` |
| **营业客运** | 选择“营业城市公交”、“营业公路客运”或“营业出租租赁”的任意组合 | `营业客运` |
| **货运车辆** | 选择“营业货车”和/或“挂车” | `货运车辆` |
| **非营货车** | 仅选择“非营业货车” | `非营货车` |
| **特种车辆** | 仅选择“特种车” | `特种车辆` |
| **摩托车业务** | 仅选择“摩托车” | `摩托车` |
| **不含摩托车** | 选择了除“摩托车”以外的所有客户类别 | `不含摩托车` |

> **注**：这是一个可扩展的规则体系。未来可根据业务需求，持续补充新的业务类型组合规则，例如"新能源车"、"高风险业务"等。

## 技术架构

- **前端框架**：Next.js 15.3.3 + TypeScript
- **样式系统**：Tailwind CSS + shadcn/ui
- **状态管理**：React Context
- **图表库**：Recharts
- **图标库**：Lucide React

## 快速开始

### 环境要求

- Node.js 18.17 或更高版本
- npm 9.0 或更高版本

### 安装依赖

```bash
cd car-insurance-dashboard
npm install
```

### 开发运行

```bash
npm run dev
```

访问 [http://localhost:9010](http://localhost:9010) 查看应用。

### 构建生产版本

```bash
npm run build
npm start
```

## 数据配置

### 数据文件结构

```
public/data/
├── metadata/
│   ├── available_years.json    # 可用年度配置
│   ├── available_weeks.json    # 可用周次配置
│   ├── data_catalog.json       # 数据文件目录
│   └── field_dictionary.json   # 字段定义字典
└── *.csv                       # 周度数据文件
```

### CSV文件格式

数据文件命名格式：`YYYY保单第WW周变动成本明细表.csv`

必须包含以下字段：
- 维度字段（17个）：时间、机构、业务、客户、风险等维度
- 度量字段（9个）：保费、赔款、费用等金额和数量指标

详细字段定义请参考 `public/data/metadata/field_dictionary.json`。

实际模板字段（与系统解析器、测试数据.csv 完全一致，按列顺序）：

```
snapshot_date,
policy_start_year,
business_type_category,
chengdu_branch,
third_level_organization,
customer_category_3,
insurance_type,
is_new_energy_vehicle,
coverage_type,
is_transferred_vehicle,
renewal_status,
vehicle_insurance_grade,
highway_risk_grade,
large_truck_score,
small_truck_score,
terminal_source,
signed_premium_yuan,
matured_premium_yuan,
policy_count,
claim_case_count,
reported_claim_payment_yuan,
expense_amount_yuan,
commercial_premium_before_discount_yuan,
premium_plan_yuan,
marginal_contribution_amount_yuan,
week_number
```

> 术语更新：`is_new_energy_vehicle` 列用于记录能源类型，取值固定为 `新能源` 或 `燃油`；`is_transferred_vehicle` 列用于记录过户状态，取值固定为 `过户` 或 `非过户`。如历史数据仍为“是/否”或布尔 `true/false`，系统会在导入时自动转换。

## KPI指标说明

### 核心指标
1. **签单保费**（万元）：SUM(signed_premium_yuan)
2. **满期赔付率**（%）：SUM(reported_claim_payment_yuan) / SUM(matured_premium_yuan) × 100
3. **费用率**（%）：SUM(expense_amount_yuan) / SUM(signed_premium_yuan) × 100
4. **满期边际贡献率**（%）：SUM(marginal_contribution_amount_yuan) / SUM(matured_premium_yuan) × 100

### 其他指标
5. **满期保费**（万元）：SUM(matured_premium_yuan)
6. **保单件数**（件）：SUM(policy_count)
7. **赔案件数**（件）：SUM(claim_case_count)
8. **变动成本率**（%）：(SUM(expense_amount_yuan) / SUM(signed_premium_yuan) + SUM(reported_claim_payment_yuan) / SUM(matured_premium_yuan)) × 100
9. **满期出险率**（%）：(SUM(claim_case_count) / SUM(policy_count)) × (SUM(matured_premium_yuan) / SUM(signed_premium_yuan)) × 100
10. **单均保费**（元）：SUM(signed_premium_yuan) / SUM(policy_count)
11. **案均赔款**（元）：SUM(reported_claim_payment_yuan) / SUM(claim_case_count)
12. **满期边际贡献额**（万元）：SUM(marginal_contribution_amount_yuan)
13. **商业险折前保费**（万元）：SUM(commercial_premium_before_discount_yuan)
14. **商业险自主系数**：SUM(signed_premium_yuan) / SUM(commercial_premium_before_discount_yuan)
15. **已报告赔款**（万元）：SUM(reported_claim_payment_yuan)
16. **费用金额**（万元）：SUM(expense_amount_yuan)

## 使用说明

### 导入数据
1. 点击页面右上角的"导入数据"按钮
2. 在弹出的导入界面中，可以：
   - 点击"下载模板"获取标准CSV模板（包含示例行）
   - 拖拽或多选多个CSV文件，系统会自动识别周次与年度并汇总校验
   - 实时查看解析进度、重复周次提醒、按文件拆分的错误/警告摘要
   - 支持一键复制错误报告，或下载合并后的验证报告（含逐行问题明细：行号/字段/级别/说明）
   - 导入成功后自动启用最近两周的对比分析，并将数据快照持久化至浏览器，以便下次直接恢复
3. 支持多文件批量上传；建议按周导入保持校验粒度

### 筛选数据
1. 在左侧筛选面板选择所需的维度条件，常用维度提供快捷按钮（最新周、最近4周、本年度、仅商业险）
2. 支持多选和单选模式，并提供“全选 / 清空 / 反选”“周次范围”等批量工具
3. 使用搜索框快速定位筛选项，应用后面板自动收起并显示摘要；点击摘要或浮出的快捷按钮可再次展开
4. 清空筛选将立即恢复默认视图并写入链接参数，便于分享复现
5. 当车险评级、高速风险等级、大货车评分、小货车评分存在空值时，筛选器会以“未评级”展示并可直接筛选空值记录

### 对比分析
1. 在右侧对比控制面板启用对比分析
2. 选择对比类型：同比、环比或自定义
3. 系统自动计算变化值和变化率
4. 变化性质通过颜色和图标直观展示

### 导出数据
1. 在筛选面板或KPI卡片中选择导出功能
2. 支持导出当前筛选结果的CSV文件
3. 包含KPI指标汇总和明细数据

## 开发指南

### 项目结构

```
src/
├── ai/               # Genkit AI 功能
├── app/              # Next.js 应用目录
├── components/       # React 组件
│   ├── dashboard/    # 仪表板特定组件
│   └── ui/           # 可重用的 UI 组件 (shadcn/ui)
├── contexts/         # 全局状态管理 (React Context)
├── hooks/            # 自定义 Hooks
└── lib/              # 辅助函数、类型定义和工具
```

### 添加新指标

1. 在 `src/types/index.ts` 中定义指标类型
2. 在 `src/utils/calculations.ts` 中添加计算逻辑
3. 在 `components/dashboard/DashboardGrid.tsx` 中配置显示顺序
4. 更新字段字典文件

### 自定义样式

项目使用 Tailwind CSS，主要样式配置在：
- `tailwind.config.js`：主题配置
- `src/app/globals.css`：全局样式和自定义CSS

## 上传到 GitHub

您可以按照以下步骤将此项目上传到您自己的 GitHub 仓库。

### 第一步：准备本地仓库

在您的项目根目录打开终端，然后执行以下命令：

1.  **初始化 Git**：
    ```bash
    git init -b main
    ```

2.  **添加所有文件到暂存区**：
    > `.gitignore` 文件已为您创建好，它会自动忽略 `node_modules` 等不需要上传的文件。
    ```bash
    git add .
    ```

3.  **创建第一次提交**：
    ```bash
    git commit -m "Initial commit"
    ```

### 第二步：在 GitHub 创建远程仓库

1.  登录您的 GitHub 账户。
2.  点击页面右上角的 **+** 号，选择 **New repository**。
3.  为您的仓库命名（例如 `car-insurance-dashboard`）。
4.  将仓库设置为 **Public**（公开）或 **Private**（私有）。
5.  **不要** 勾选 "Add a README file" 或 "Add .gitignore"。
6.  点击 **Create repository**。

### 第三步：关联并推送代码

创建仓库后，复制页面上提供的仓库 URL。回到您的终端执行以下命令：

1.  **关联远程仓库** (请将 URL 替换为您自己的):
    ```bash
    git remote add origin https://github.com/YourUsername/YourRepositoryName.git
    ```

2.  **推送代码到 GitHub**:
    ```bash
    git push -u origin main
    ```

完成这些步骤后，您的项目代码就会出现在您的 GitHub 仓库中。

## 故障排除

### 常见问题

1. **数据导入失败**
   - 检查 CSV 文件格式是否符合模板要求
   - 确认必需字段是否完整
   - 查看数据验证错误信息并修复
   - 检查数值字段是否包含非法字符
   - 说明：
     - 逐行解析失败不会中断导入，跳过该行并记录到“问题明细”与报告
     - `已报告赔款`/`费用金额`允许负值（冲销），作为“警告”提示，不阻止导入
     - “赔案件数>保单件数”在部分场景属正常，不再提示为问题

### 筛选器使用优化
- 核心筛选（年度/周次/机构/保险类型/险种）默认展开
- 多选支持：全选/清空/反选；周次支持“范围选择”“最近4周”快捷操作
- 草稿-应用模式：变更先在草稿中累积，点击“应用筛选”后生效（并写入URL），便于分享与复现
- 应用后筛选器自动收起，显示简洁摘要条与“调整筛选/清空”按钮，聚焦数据展示

### 视觉风格
- 整体偏向苹果发布会风格：留白、渐变背景、玻璃态卡片、细腻动效
- KPI 卡片采用玻璃态（backdrop-blur）与柔和阴影，标题使用渐变字色

2. **KPI计算异常**
   - 验证数据中是否包含必需字段
   - 检查数值字段是否为有效数字
   - 确认分母不为零的情况处理

3. **筛选器无响应**
   - 确认数据已正确导入
   - 检查筛选选项是否从数据中正确提取
   - 验证筛选逻辑是否正确应用

4. **文件上传问题**
   - 确保文件格式为CSV（.csv）
   - 检查文件大小是否过大（建议<10MB）
   - 确认文件编码为UTF-8

### 日志调试

开发模式下，相关日志会输出到浏览器控制台：
- 数据加载过程
- 计算错误信息
- 筛选应用状态

## 版本信息

- 当前版本：v1.0.0
- 更新日期：2025-10-06
- 兼容数据版本：1.0.0

## 许可证

本项目仅供内部使用，版权所有。

## 支持

如有问题或建议，请联系开发团队。
