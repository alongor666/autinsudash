# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 在此代码仓库中工作时提供指导。
## 🎯 重要约定

**开发进度同步约定**：
1. **开发前必读**：每次开始工作前，必须先查阅 `开发进度.md` 了解：
   - 当前版本状态和已完成功能
   - 待办任务的优先级排序
   - 已知的风险阻塞项
2. **开发中更新**：功能开发过程中如遇到新问题或状态变化，及时更新 `开发进度.md`
3. **完成后同步**：功能完成后必须：
   - 将对应任务状态从待办改为已完成
   - 更新相关文档（README.md、PLAN.md、CLAUDE.md、PRD.md）
   - 记录完成时间和关键说明

**文档一致性检查**：每次提交前确保所有文档描述与实际代码功能保持一致。

## 项目概述
这是一个**车险多维分析系统** - 基于 React 的仪表板应用程序，用于分析车险数据，具有 16 个 KPI 可视化和多维过滤功能。

## 开发命令

### 核心开发
```bash
npm run dev                 # 启动开发服务器，端口 9010，使用 Turbopack
npm run build              # 构建生产版本
npm start                  # 启动生产服务器
npm run lint               # 运行 Next.js 代码检查
npm run typecheck          # 运行 TypeScript 类型检查
```

### AI 集成（可选）
```bash
npm run genkit:dev         # 启动 Genkit AI 开发服务器
npm run genkit:watch       # 启动 Genkit 文件监听模式
```

## 架构概述

### 技术栈
- **Next.js 15.3.3** (App Router) 配合 TypeScript
- **React 18.3.1** 使用 Context API 进行状态管理
- **Tailwind CSS** + **shadcn/ui** 组件库
- **Recharts** 用于数据可视化
- **IndexedDB** 用于客户端数据持久化
- **Google AI (Genkit)** 用于智能洞察

### 关键目录结构
```
src/
├── app/                    # Next.js App Router (page.tsx, layout.tsx)
├── components/
│   ├── dashboard/                          # 主要仪表板组件
│   │   ├── header.tsx                      # 板块导航栏（设置、经营概览等）
│   │   ├── kpi-grid.tsx                    # KPI 矩阵显示与智能洞察
│   │   ├── kpi-card.tsx                    # 单个 KPI 卡片
│   │   ├── ai-deterioration-analysis.tsx   # AI 恶化分析组件
│   │   ├── weekly-trend.tsx                # 最近12周柱线组合趋势图
│   │   ├── customer-performance.tsx        # 占比图、条形对比图、费用结余图容器
│   │   ├── comparison-analysis.tsx         # 对比分析图表
│   │   ├── filter-summary.tsx              # 筛选摘要显示
│   │   └── top-filters.tsx                 # 智能筛选面板
│   ├── ui/               # shadcn/ui 可复用组件
│   └── data/             # CSV 导入/导出组件
├── contexts/
│   └── data-context.tsx  # 全局状态管理
├── lib/                  # 工具函数和类型定义
│   ├── color-scale.ts    # 颜色映射规则
│   └── csv.ts            # CSV 解析与导出
└── hooks/                # 自定义 React hooks
```

### 数据模型
系统处理车险数据包含：
- **17 个维度字段**：时间周期、机构、客户类别、风险等级
- **9 个度量字段**：保费、赔款、费用、保单数量
- **16 个 KPI 计算**：标准保险指标及特定公式
- 字段取值约定：`is_new_energy_vehicle` 为能源类型（新能源/燃油），`is_transferred_vehicle` 为过户状态（过户/非过户）；导入旧的“是/否”或布尔 `true/false` 取值时会自动转换。

### 状态管理
- 单一 **DataProvider** 上下文包装整个应用程序
- 数据持久化到浏览器的 IndexedDB 以支持离线功能
- 实时过滤触发所有组件的 KPI 重新计算

### 板块切换逻辑
- 顶部导航按钮映射六个核心板块：设置、经营概览、趋势洞察、结构分析、对比分析、费用分析
- 设置板块整合数据导入/导出、筛选配置等功能，其他板块聚焦分析任务
- 仅当前激活板块会渲染具体内容，其余板块保持隐藏以聚焦当前分析
- 激活状态驱动渐变高亮与光晕效果，营造轻量科技感体验

## 核心功能与业务逻辑

### 智能客户类别切片
复杂过滤器组合映射到客户类别组合：
- **私家车**、**单位客车**、**非营客车组合**
- **营业客运**、**货运车辆**、**非营货车**、**特种车辆**、**摩托车业务**、**不含摩托车**
- 映射规则位于 `/src/lib/data.ts` 的 `customerCategoryCombinations` 配置中

### KPI 计算与展示
所有 16 个指标遵循标准保险公式：
- **签单保费**：`SUM(signed_premium_yuan)`
- **满期赔付率**：`SUM(reported_claim_payment_yuan) / SUM(matured_premium_yuan) × 100`
- **费用率**：`SUM(expense_amount_yuan) / SUM(signed_premium_yuan) × 100`

#### KPI 看板功能
- **动态标题**：基于本周与上周对比生成智能洞察
  - 恶化判断：满期赔付率上升>1pp、费用率上升>0.5pp、满期边际贡献率下降>0.5pp
  - 示例："经营效率出现恶化：满期赔付率上升3.2pp，费用率上升1.5pp"
- **4行矩阵布局**：核心KPI与二级指标平铺展示，无下钻交互
  - 第1行：签单保费（核心） + 满期保费 + 保单件数 + 单均保费
  - 第2行：满期赔付率（核心） + 已报告赔款 + 案均赔款 + 满期出险率
  - 第3行：费用率（核心） + 费用金额 + 单均费用
  - 第4行：满期边际贡献率（核心） + 变动成本率 + 满期边际贡献额 + 终极边际贡献额
- **终极边际贡献额**：签单保费 × 满期边际贡献率，基于终极赔付率=满期赔付率的假设
- **环比展示优化**：
  - 所有指标（核心+二级）显示本周数据，旁边显示上周数值作为对比
  - 环比变化使用彩色徽章突出显示（上升为红色、下降为绿色）
  - 徽章内包含趋势图标、变化百分比和绝对变化值（万/pp/件/元）
- **视觉层次**：
  - 核心KPI字体28px，二级指标字体20px
  - 所有卡片采用固定高度布局确保指标名称、数值、环比变化垂直对齐一致
- **数值精度规范**：绝对值显示整数，率值保留一位小数
- **AI恶化分析**：当检测到满期赔付率或费用率恶化时，自动分析恶化维度
  - 下钻顺序：业务类型 → 三级机构 → 终端来源 → 风险评分
  - 满期赔付率根因：进一步分解为出险率和案均赔款变化

完整公式记录在 README.md 第 141-160 行。

### 周度趋势组合图
- 位置：趋势洞察板块，默认聚焦最近 12 周数据。
- 柱状侧仅提供绝对值指标（保费、件数、费用等），按规范取整展示；折线侧限定率值/占比指标（赔付率、费用率、边际贡献率等），按规范保留 1 位或 3 位小数。
- 柱状图颜色基于对应周的满期边际贡献率动态计算，遵循颜色规范（绿/蓝/黄/红色系）。
- 继承占比图的维度选择列表，并新增"筛选取值"下拉以锁定单个维度成员，默认展示"全部"维度汇总。
- 支持在 Tooltip 中同时查看两个指标的格式化数值，Legend 随指标切换自动更新。
- 周序号多选仅在该板块生效，其余图表与 KPI 默认回退到最新一周数据。
- 去除网格线，保持图表简洁清晰。

### 数据导入系统
- CSV 拖拽上传及验证
- 多文件批量上传支持
- 实时解析进度和错误报告
- 标准化 36 列格式模板下载

## 开发指南

### 组件模式
- 统一使用 **shadcn/ui** 组件
- 遵循现有的玻璃态设计（backdrop-blur、渐变）
- KPI 卡片使用复合组件模式和标准化布局，支持点击下钻功能
- 所有交互组件支持响应式设计
- 图表标题采用麦肯锡金字塔原理，以核心观察引导用户关注

### 添加新 KPI
1. 在 `src/types/index.ts` 中定义类型
2. 在 `src/utils/calculations.ts` 中添加计算逻辑
3. 在 `components/dashboard/DashboardGrid.tsx` 中配置显示
4. 如需要更新字段字典

### 样式系统
- **Tailwind CSS** 配合 `tailwind.config.ts` 中的自定义主题
- 颜色语义：红色 `#F04438`（风险）、绿色 `#12B76A`（正向）、蓝色 `#1D4ED8`（中性）
- 字体层级：H1(46px)、H2(32px)、H3(24px)、正文(16px)、辅助(14px)
- 苹果发布会美学风格，流畅动画效果

### 数据处理
- 所有数据操作通过 DataContext 进行
- CSV 解析处理中文字段名和各种数据格式
- 错误处理包含行级验证和详细报告
- 支持赔款/费用负值（冲销）

## 配置文件
- **`next.config.ts`**：忽略构建错误以提供开发灵活性
- **`tsconfig.json`**：使用 `@/*` 别名的路径映射
- **`tailwind.config.ts`**：全面的主题和设计令牌
- **`.env`**：包含 Gemini API 密钥用于 AI 功能
- **`apphosting.yaml`**：Firebase 部署配置

## 数据要求
CSV 文件必须遵循 36 列模板格式，字段名称需与字段字典中指定的完全一致。关键字段包括用于过滤的维度字段（17个）和用于计算的度量字段（9个）。

## AI 集成
系统包含 Google AI 集成，使用 Gemini 2.5 Flash 模型提供智能洞察。AI 功能对过滤数据和业务场景提供上下文分析。

## 图表显示规范

### 颜色规范
基于满期边际贡献率的颜色映射规则：
- **绿色系**：满期边际贡献率 > 12%，数值越大颜色越深
- **蓝色系**：满期边际贡献率 8%-12% 区间，数值越大颜色越深
- **黄色系**：满期边际贡献率 4%-8% 区间，数值越小颜色越深
- **红色系**：满期边际贡献率 < 4% 区间，数值越小颜色越深

### 排序规范
- 所有图表必须支持排序功能
- 提供从大到小和从小到大的排序切换
- 默认排序方式根据业务需求确定

### 数值显示规范
- **绝对值**：取整数显示（如保费金额、件数）
- **率值或占比**：保留一位小数（如赔付率、费用率）
- **自主系数**：保留三位小数

### 数值标签显示规范
- **柱状图和条形图**：必须显示数值标签
- **标签位置**：数值标签不能触碰 X 轴或 Y 轴
- **空间处理**：必要时整体压缩条形图的长度或柱状图的高度，确保标签完整显示
- **正负值适配**：无论正值还是负值，数值标签都必须清晰可见且不重叠
