# 车险多维分析系统

> 最近更新：2025-10-06

## 概述
- 目标：以 4×4 KPI 看板 + 多维筛选，面向业务与管理者提供周度车险经营分析能力。
- 技术：Next.js 15.3.3（TS）、Tailwind、Context 状态、无后端示例数据/本地 CSV 导入。

## 设计理念与原则
- 信息架构优先：采用倒金字塔结构，核心指标置于视觉焦点，确保用户在 5 秒内理解页面主旨。
- Apple 式极简：整体采用 SF Pro 字体、柔和渐变背景与玻璃质感卡片，延续苹果官网的沉浸式观感。
- 语义一致：色彩、图标、动效均遵循统一语义；红/黄/蓝/绿仅保留给“满期边际贡献率”四区间映射与破坏性系统提示（组件库语义色），不用于装饰背景与一般高亮。
- 渐进披露：复杂能力按层级逐步呈现，避免一次性暴露所有控件造成认知过载。
- 数据驱动：所有设计围绕决策需求展开，突出趋势、异常、对比与效率洞察。

### 设计系统蓝图
- **色彩语义体系（更新）**：
  - 状态色专用：红/黄/蓝/绿仅用于“满期边际贡献率”四区间映射，不参与装饰/背景；错误/破坏性操作沿用组件库语义红色（Toast/对话框）。
  - 通用强调：采用紫系（violet/indigo/fuchsia）与中性灰作为非状态的高亮与装饰色。
  - 辅助色：背景柔和灰（浅色）+ 玻璃态白面板；分隔线使用中性灰；浅/深色主题保证对比度达标。
- **字体层级体系**：
  - 标题（H1/H2/H3）：46/32/24 px，字重 600，行距 1.2，支持渐变标题以强调模块主题。
  - 正文（Body/Micro）：16/14 px，字重 400，行距 1.5，提供 12 px 辅助标签，统一使用数字等宽字体展示指标。
  - 信息密度：KPI 卡片保留 16 px 内边距，核心指标与辅助指标之间保持 8 px 间距。
- **核心组件倒金字塔信息层**：
  - KPI 卡片：顶部为 5 秒核心指标（数值 + 环比/同比箭头），中层展示关键维度（如机构/险种标签），底部由 AI 生成相关的下钻分析文本。
  - 图表容器：首屏显示图表标题 + 关键结论摘要（例如“赔付率连续 3 周下降 5%”），主体为图表本体，底部提供筛选摘要与异常说明。
  - 筛选面板：第一层显示最常用维度（年度、周次、机构），第二层折叠高级维度，第三层提供保存/预测推荐区。

## 关键能力
- KPI 看板（16 项）：绝对值、核心率值、运营指标、商业险专项。
- 经营概览视觉：核心 KPI 与二级指标按行共享主题色调，统一玻璃质感卡片，同时展示环比变化幅度与绝对变化值（万元/pp）。
- 多维筛选：年度、周次、机构层级、三级机构、保险类型、险别组合、客户类别、业务类型、能源类型、过户车、新续转状态、车险评级、高速风险等级、大货车评分、小货车评分、终端来源共16维。
- 术语统一：能源类型字段使用“新能源/燃油”值，过户车字段使用“过户/非过户”值，历史“是/否”或布尔 `true/false` 数据在导入时自动转译。
- 对比分析：同比/环比/自定义；可按筛选条件对比聚合值。
- 图表数据视图：经营概览、趋势洞察、结构分析、对比分析、费用分析板块的维度控制区统一保留“查看数据”开关，并让 AI 深度分析按钮与各筛选选项平行排布；复制数据按钮改为仅在表格视图顶部展示，可一键复制当前表格快照，保持操作区域干净一致。
- AI 问题归因：签单保费下降、满期赔付率和费用率恶化时自动识别维度贡献，并提供板块选择入口以扩展更多分析模板。
- 数据导入：CSV 模板下载、上传校验、错误/警告明细、一键复制/下载报告。
- 导出：KPI 概览 + 明细 CSV。
- 图表洞察：
  - 占比图支持13个维度切换（客户类别、机构层级、三级机构、业务类型等），内/外环指标可自由组合
  - 条形对比图支持13个维度和15个指标交叉分析，自动缩放极值
  - 费用结余图基于14%基准线展示各维度费用优化潜力
  - 所有图表采用麦肯锡金字塔原理，核心观点置于标题，说明文字仅保留计算逻辑，去除已在标题/选择器中体现的冗余信息

## 智能客户类别切片 (Customer Category Slicing)

为了提升分析效率和用户体验，系统引入了“智能客户类别切片”功能。此功能将复杂的多维度选项组合映射为简洁、易于理解的客户类别别名。该映射同时应用于动态标题生成和智能洞察（AI搜索）中。

### 当前别名规则 (可扩展)

| 客户类别别名 | 触发条件 (客户类别 `customer_category_3`) | AI 搜索关键词 |
| :--- | :--- | :--- |
| **私家车** | 仅选择“非营业个人客车” | `私家车` |
| **单位客车** | 选择“非营业企业客车”与/或“非营业机关客车” | `单位客车` |
| **非营客车组合** | 同时选择“非营业个人客车”、“非营业企业客车”、“非营业机关客车” | `非营客车` |
| **营业客运** | 选择“营业城市公交”、“营业公路客运”或“营业出租租赁”的任意组合 | `营业客运` |
| **货运车辆** | 选择“营业货车”和/或“挂车” | `货运车辆` |
| **非营货车** | 仅选择“非营业货车” | `非营货车` |
| **特种车辆** | 仅选择“特种车” | `特种车辆` |
| **摩托车业务** | 仅选择“摩托车” | `摩托车` |
| **不含摩托车** | 选择了除“摩托车”以外的所有客户类别 | `不含摩托车` |

> **注**：这是一个可扩展的规则体系。未来可根据业务需求，持续补充新的别名与组合规则，例如“新能源车”、“高风险业务”等。

## 信息架构与交互策略
- 筛选面板：默认展示常用维度，支持草稿-应用模式，应用后折叠为摘要条并保留上下文筛选状态。
- 快捷操作：提供最新周、最近 4 周、本年度、仅商业险等快捷按钮，并支持键盘快捷键与触控手势。
- 图表联动：单图点击可驱动其他图表同步刷新，保持筛选上下文一致。
- 实时反馈：筛选、钻取、对比切换提供即时响应，避免等待感。

## 仪表板信息架构规划
- 布局：采用 12 列响应式栅格，首屏为**经营概览**板块，包含 4x4 KPI 看板和全局筛选摘要。顶部导航栏可在**趋势洞察**、**结构分析**、**对比分析**、**费用分析**和**设置**等核心板块间切换。
- 5 秒核心信息：每个区域的首个元素必须在 5 秒内呈现主要结论，并在标题下方以微文案加粗提示。

| 区块 | 视图名称 | 5 秒核心信息 | 图表类型 | 联动逻辑 |
| --- | --- | --- | --- | --- |
| KPI 看板 | 核心经营指标（保费、赔付率、费用率、边际贡献） | “本周 vs 上周差异（幅度 + 绝对值）+ 行级主题提示” | 主题化 KPI 卡片矩阵 | 无交互点击功能，相关分析由 AI 自动生成并展示在卡片下方。 |
| 趋势洞察 | 最近12周经营趋势 | “近 12 周绝对值与率值的同步波动” | 柱状+折线组合图 | 柱状侧仅提供绝对值指标、折线侧仅提供率值/占比指标，继承占比图的维度及取值筛选；周序号多选仅在此板块生效；点击异常点同步打开异常说明卡片 |
| 趋势洞察 | 理赔处理时效 | “平均处理时长是否超阈” | 面积+折线混合图 | 与“理赔效率”KPI 联动，选择时间段同步更新处理时长分布 |
| 结构对比 | 机构对比 | “Top/Btm 5 机构贡献与赔付差异” | 水平条形图 | 点击机构刷新右侧险种分布饼图，并在 KPI 摘要中突出该机构数据 |
| 结构对比 | 险种构成 | “商业险 vs 交强险占比” | 环形图 | 继承机构筛选状态；点击分区向趋势图发送筛选事件 |
| 区域聚焦 | 区域热力 | “高赔付率地区” | 地图热力/矩形树图（按终端） | 与“异常预警列表”双向联动，点击区域刷新异常列表 |
| 区域聚焦 | 异常预警列表 | “异常指标与建议动作” | 列表 + 标签 | 监听所有图表点击事件，展示对应筛选上下文并支持导出 |

- 响应式策略：桌面端三段并排；平板堆叠为双列；移动端以卡片形式纵向排列，首屏保留 4 个 KPI 与趋势图。

## 数据导入与校验
模板列顺序与测试数据.csv 完全一致，详见 README。

- 错误（阻塞导入）：
  - 必填字段为空（含年度/周次/机构/险种/保险类型等）。
  - 件数字段为负：`policy_count`、`claim_case_count`。
  - 单行解析失败或列数不匹配（该行跳过，计入明细）。
- 警告（不阻塞导入）：
  - `reported_claim_payment_yuan`、`expense_amount_yuan` 为负（冲销）。
  - 数值为空/非法（按场景提示）。
- 忽略（不提示）：
  - `claim_case_count > policy_count`（在旧案跨期/并案等场景合理）。

报告能力：
- 逐行“问题明细”（行号/字段/级别/说明）。
- 汇总“解析阶段跳过行数”。
- 一键复制/下载验证报告，导入成功后自动保存快照并预设最新两周对比。
- 支持多文件并行解析：按文件出具校验摘要，检测重复周次并提示覆盖策略。

## 数据恢复与对比
- 浏览器本地缓存最近一次导入结果（IndexedDB+localStorage），刷新后自动恢复数据与筛选项。
- 识别导入数据的最近两周期，自动启用自定义对比（Latest vs Previous）。
- 提供“数据清空”入口以移除本地快照。

## 筛选器 UX（确认后隐藏）
- 默认展开常用维度：年度、周次、三级机构、客户类别、车险种类。
- 草稿-应用模式：变更先暂存，点击“应用筛选”后生效并写入 URL（可分享复现）。
- 应用后自动收起为“摘要条”（显示记录数与已选关键信息），支持“调整筛选/清空”，点击面板外部自动隐藏。
- 多选：全选/清空/反选；周次支持“范围选择”“最近4周”。
- 新增常用快捷按钮：最新周、最近4周、本年度、仅商业险，点击后立即应用并折叠面板。

## 智能交互流程
- **预测式筛选**：
  1. 用户在筛选面板输入关键字（如“天府”），系统基于历史筛选记录与业务热点推荐前三项维度组合，并标记预测可信度。
  2. 推荐项悬浮时展示“预计影响指标”提示卡（引用 KPI 数据快照）。
  3. 用户选择后立即生成预览标签，支持一键应用或保存为常用方案。
- **渐进式披露**：
  1. 首屏仅展示基础筛选与核心 KPI，当用户点击“深入分析”按钮后展开二级视图（趋势洞察 + 结构对比）。
  2. 在趋势图上点击异常点弹出侧边层，展示详细表格与建议动作；若用户进一步点击“查看关联事件”，再打开三级信息（原始记录、注释、分享）。
- **实时反馈**：
  1. 所有筛选/图表操作均触发 loading skeleton < 200ms；
  2. 图表更新采用局部重绘并保留过渡动效（150–200ms），同时在筛选摘要条中闪现“已更新”提示；
  3. 失败时提供可恢复提示（重试按钮 + 联系人信息），并回滚至上一个成功状态。
- **AI 问题归因**：
  1. 监测签单保费环比下降超过 0.5 万、满期赔付率或费用率环比上升超过 0.1pp 时自动触发归因卡片。
  2. 归因顺序遵循业务类型 → 三级机构 → 终端来源 → 风险评分，逐级输出前 5 个恶化来源，展示“本周值 / 上周值 / 变化值”。
  3. 卡片顶部提供“选择分析板块”按钮，后续可切换趋势洞察、结构对比等模块，AI 将基于所选板块拉取数据并生成专属分析。

## KPI 口径（聚合后计算）
- 满期赔付率 = 已报告赔款 / 满期保费 × 100（上升为负向）。
- 费用率 = 费用金额 / 签单保费 × 100（上升为负向）。
- 变动成本率 = (费用金额 ÷ 签单保费) + (已报告赔款 ÷ 满期保费)（结果以百分比展示，上升为负向）。
- 满期边际贡献率 = 满期边际贡献额 / 满期保费 × 100。
- 满期出险率 = (赔案件数 / 保单件数) × (满期保费 / 签单保费) × 100（上升为负向）。
- 单均保费 = 签单保费 / 保单件数
- 案均赔款 = 已报告赔款 / 赔案件数（上升为负向）。
- 商业险自主系数 = 签单保费 / 商业险折前保费。

## 数据可视化规范
- 图表选择：趋势=折线图、占比=饼/环图、对比=柱图、相关性=散点图，避免 3D 和夸张装饰。
- 数据密度：遵循"数据墨水比"原则，自动聚合时间粒度，保持信息密度与可读性平衡。
- 异常标注：自动识别并高亮异常点，提示变化原因或业务解读。
- 动效准则：动效用于强调趋势与切换，保持节奏克制，不干扰阅读。

### 图表颜色规范
基于满期边际贡献率的颜色映射规则：
- **绿色系**：满期边际贡献率 > 12%，数值越大颜色越深
- **蓝色系**：满期边际贡献率 8%-12% 区间，数值越大颜色越深
- **黄色系**：满期边际贡献率 4%-8% 区间，数值越小颜色越深
- **红色系**：满期边际贡献率 < 4% 区间，数值越小颜色越深

### 图表排序规范
- 所有图表必须支持排序功能
- 提供从大到小和从小到大的排序切换
- 默认排序方式根据业务需求确定

### 数值显示规范
- **绝对值**：取整数显示（如保费金额、件数）
- **率值或占比**：保留两位小数（如赔付率、费用率）
- **自主系数**：保留三位小数

## 视觉风格（Apple Keynote）
- 背景：柔和渐变 + 合理留白；卡片/容器统一采用玻璃态白面板（见 Panel Token），标题可使用克制的渐变字色。
- 字体层级：字号、字重、行距成体系，强化主次；正文保持高对比度与充足间距。
- 色彩体系：状态色红/黄/蓝/绿保留给“边际贡献率映射”，其余使用紫系与中性灰；支持浅色/深色主题切换。
- 高分屏适配：保证 4K/Retina 下的像素精度与图标清晰度。

### Panel Surface Token（新增）
- CSS 变量：`--panel-bg`、`--panel-border`，默认值为 `rgba(255,255,255,0.8)` 与 `rgba(255,255,255,0.6)`，深色模式维持同等玻璃态观感。
- 工具类：`.panel-surface` 统一设置容器背景与边框颜色；适用于看板容器、卡片、图表容器、抽屉等壳层组件。

## 非功能需求
- 性能：本地数据 1–3 万行 CSV 流畅操作（按浏览器能力）。
- 易用：一键复制报告、URL 参数分享、筛选方案本地保存。
- 安全：不提交真实业务数据；环境变量入 .env.local。

## 性能与响应式方案
- **数据懒加载**：
  - 初次渲染仅请求 KPI 汇总与关键趋势数据，其余视图在进入视口或用户互动时再异步加载。
  - 使用 Web Worker 解析 CSV，主线程仅接收聚合结果，避免 UI 卡顿。
- **缓存策略**：
  - IndexedDB 存储原始数据与聚合快照；localStorage 保存筛选条件、主题设置与布局方案。
  - 设置 24 小时 TTL，超过自动触发后台刷新；手动刷新时保留旧数据直至新数据就绪（stale-while-revalidate）。
- **图表自适应规范**：
  - 栅格断点：≥1280px（四列）、≥960px（三列）、≥640px（两列）、<640px（单列）。
  - 轴标签自动旋转/省略，迷你图在移动端切换为面积图卡片，地图在移动端替换为列表热力。
- **性能监控**：
  - 关键指标：首次内容绘制 < 2s，交互响应 < 200ms，图表切换 < 400ms。
  - 埋点工具：利用 Web Vitals + 自研埋点上报筛选耗时、加载失败率，并在仪表板内置性能调试模式。

## 迭代建议
- 忽略规则设置：允许用户在本地偏好中关闭某类警告显示。
- 机构树选择/多层级汇总；KPI 点击下钻；图表化分布视图。
- 智能推荐：基于用户行为历史提供预测性筛选、推荐关注指标。
- 协同扩展：支持注释、分享视图与多格式导出，完善协作闭环。

## 个性化与协作能力路线
- **布局拖拽**：采用虚拟栅格 + 拖拽库（如 React Grid Layout），支持保存多个布局方案并设置默认视图；拖拽时提供吸附对齐与栅格高亮反馈。
- **视图保存**：
  - 本地：保存筛选组合、布局与主题到 IndexedDB，列表展示最近使用与共享的方案。
  - 云端（未来扩展）：提供分享链接，附带有效期与访问控制。
- **主题切换**：维护统一主题 Token（颜色、阴影、圆角），在浅色/深色间动态切换；允许用户进一步调节对比度以适配高亮需求。
- **注释与分享**：图表右上角提供“添加注释”入口，可标记某个数据点并 @ 成员；注释面板支持 Markdown、上传截图，并同步更新到协作日志。
- **导出能力**：一键导出 PDF（看板快照）、CSV（当前筛选结果）与 PPT（含关键图表 + 注释摘要），导出前展示预览与敏感字段脱敏选项。

## 行业标杆评估与成功要素
- **差异化对标**：
  - Tableau：可视化自由度高但学习曲线陡峭峭；本产品聚焦标准化仪表板与 5 秒核心信息，让业务用户零学习即可使用。
  - Power BI：数据集成与建模强；我们利用本地 CSV + 智能筛选提供轻量部署，并通过预测式筛选弥补缺乏复杂建模的痛点。
  - 阿里 DataV：大屏炫酷但交互复杂；我们以倒金字塔信息层和渐进披露保障信息可读性，减少视觉噪音。
- **差异化要点总结**：5 秒洞察、预测筛选、自动异常说明、拖拽布局 + 主题 Token、内置性能自监控。
- **迭代节奏**：
  - M0（当前）：完成基础仪表板、懒加载、缓存与主题切换能力。
  - M1：上线预测式筛选、异常说明卡、拖拽布局 Beta，邀请核心用户试用。
  - M2：开放注释分享、云端视图同步，叠加性能自监控仪表板并评估新数据源接入。
- **成功关键**：建立统一设计系统，保持跨职能团队的每周例会，持续开展用户访谈与可用性测试，确保体验围绕业务决策价值持续迭代。
