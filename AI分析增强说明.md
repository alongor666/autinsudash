# AI 分析报告增强功能说明

## 📋 功能概述

已成功实现 AI 分析报告的富文本展示，支持数据颜色标注、层次结构和三层下钻分析。

## 🎨 核心特性

### 1. **颜色体系**
基于满期边际贡献率自动着色：
- 🟢 **绿色** (>12%): 优秀表现
- 🔵 **蓝色** (8-12%): 良好表现
- 🟡 **黄色** (4-8%): 需要关注
- 🔴 **红色** (<4%): 预警状态

变化趋势颜色：
- 🔴 **红色**: 上升/恶化（赔付率↑、费用率↑）
- 🟢 **绿色**: 下降/优化（费用下降、效率提升）

### 2. **三层下钻分析**
按金字塔原理层层递进：
- **一级下钻** (蓝色区块): 客户类别细分
- **二级下钻** (靛蓝区块): 业务类型分布
- **三级下钻** (紫色区块): 三级机构 → 险别组合

### 3. **标记语法规范**

AI 使用以下标记生成结构化报告：

```
{metric|标签|数值}          - 指标数值（自动着色）
{color|颜色|文本}           - 强制颜色（green/blue/yellow/red）
{change|类型|数值}          - 变化标签（rise红/drop绿）
{dim|维度|取值}             - 维度标签（中性蓝色）
{org|类型|名称}             - 机构标签（紫色+图标）
[DRILLDOWN]...[/DRILLDOWN] - 一级下钻区块
[LEVEL2]...[/LEVEL2]       - 二级下钻区块
[LEVEL3]...[/LEVEL3]       - 三级下钻区块
```

## 📁 文件结构

### 新增文件
- **`src/lib/ai-markup.ts`** - 标记语法解析器（270+ 行）
  - `parseAIMarkup(text)`: 主解析函数
  - 支持所有标签类型和下钻区块
  - 自动 XSS 防护

### 修改文件
1. **`src/app/api/analyze-chart/route.ts`**
   - 新增 `DrilldownDatum` 类型
   - 增强 prompt 包含标记语法规范
   - 提供详细的三层下钻示例
   - TOP5 → TOP10 数据（更全面分析）

2. **组件更新** (3 个文件)
   - `src/components/dashboard/customer-performance.tsx`
   - `src/components/dashboard/comparison-analysis.tsx`
   - `src/components/dashboard/weekly-trend.tsx`
   - 替换 `convertTextToHtml` → `parseAIMarkup`
   - 调整 `space-y-2` → `space-y-3` (增加下钻区块间距)

## 🎯 使用示例

### 输入（AI 生成的标记文本）
```
{dim|客户类别|私家车}以{metric|签单保费|1250万}占比最高，{metric|满期边际贡献率|15.5%}表现{color|green|优秀}。

关键发现：
1. {dim|客户类别|私家车}规模领先
2. {dim|客户类别|货运车辆}的{metric|边际贡献率|3.8%}处于{color|red|红色预警区间}

[DRILLDOWN]
{dim|客户类别|私家车}细分：
- {dim|业务类型|非营客车}: {metric|签单保费|800万}，{metric|边际贡献率|16.5%}
[/DRILLDOWN]

[LEVEL2]
{dim|业务类型|非营客车}机构分布：
- {org|三级机构|营业部A}: {metric|签单保费|320万}，{metric|边际贡献率|18.5%}
[/LEVEL2]

[LEVEL3]
{org|三级机构|营业部A}险别结构：
- {dim|险别|车损+三者}: {metric|签单保费|180万}，{metric|边际贡献率|20.1%}
[/LEVEL3]
```

### 输出（渲染效果）
- ✅ 所有指标自动着色（绿/蓝/黄/红）
- ✅ 维度名称带彩色标签
- ✅ 三级下钻区块层次分明
- ✅ 机构名称带 🏢 图标
- ✅ 变化趋势带 ↑↓ 箭头

## 🔍 技术亮点

1. **安全性**: 自动 HTML 转义防止 XSS 攻击
2. **容错性**: 标记语法比 JSON 更适合 AI 生成
3. **可扩展**: 轻松添加新标签类型
4. **性能**: 纯客户端解析，无额外 API 调用
5. **视觉层次**: Tailwind CSS 样式，符合项目设计规范

## 📊 视觉预览

运行测试页面查看效果：
```bash
open test-ai-markup.html
```

## ⚙️ API 调用示例

前端组件无需修改数据传递逻辑，API 会自动：
1. 接收图表数据（TOP10）
2. 生成包含标记语法的分析报告
3. 前端使用 `parseAIMarkup` 自动渲染

## 🚀 后续优化方向

1. **更深层下钻**: 支持 4-5 层下钻（需传递完整原始数据）
2. **交互式下钻**: 点击展开/折叠下钻区块
3. **导出功能**: 支持导出带样式的 PDF/Word 报告
4. **自定义颜色**: 用户可配置边际贡献率阈值
5. **多维对比**: 同时展示多个维度的下钻分析

## 📝 注意事项

1. AI 可能不会每次都完美遵循标记语法，建议：
   - 在 prompt 中强调"**必须使用标记语法**"
   - 提供详细的输出示例
   - 限制输出长度（避免 token 超限）

2. 颜色映射规则固定，确保与系统其他部分一致：
   - 参考 `src/lib/color-scale.ts` 的 `getMarginalContributionColor`
   - 所有率值自动判断区间着色

3. 下钻层级固定为三层：
   - L1: 客户类别
   - L2: 业务类型
   - L3: 三级机构 + 险别组合
   - 更深层次由用户通过筛选器自行探索

## ✅ 完成清单

- [x] 创建标记语法解析器
- [x] 定义颜色映射规则
- [x] 增强 API 路由支持下钻
- [x] 优化 AI Prompt
- [x] 更新 3 个图表组件
- [x] 创建测试页面
- [x] 编写使用文档

---

**开发时间**: 2025-10-06
**影响范围**: AI 分析功能全面增强
**兼容性**: 向后兼容，旧的纯文本报告也能正常渲染
