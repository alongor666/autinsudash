# 开发进度.md

> 最近更新：2025-10-06 14:30（提交代码前请同步校准时间）

## 版本概览
- 当前阶段：M0 核心 KPI 仪表板 MVP
- 数据形态：本地 CSV 上传 + IndexedDB 本地缓存，无后端接口
- 必须对齐文档：`README.md`（快速开始与数据规范）、`prd.md`（体验蓝图）、`开发进度.md`（本文档）
- 术语统一：新能源/过户相关筛选字段改为“能源类型（新能源/燃油）”与“过户车（过户/非过户）”，导入时自动兼容历史“是/否”或布尔 `true/false` 取值（2025-10-05）

## 已上线功能
| 模块 | 状态 | 最近更新时间 | 关键说明 | 相关文件 |
| :--- | :--- | :--- | :--- | :--- |
| 前端基础设施 | ✅ | 2024-09-22 | Next.js 14 + TypeScript 项目初始化，整合 Tailwind + shadcn/ui 与 App Router 布局 | `package.json`、`src/app/layout.tsx` |
| 数据导入与缓存 | ✅ | 2024-09-22 | 支持 CSV 上传解析，并通过 IndexedDB 持久化上次数据 | `src/app/page.tsx`、`src/lib/csv.ts`、`src/lib/idb.ts` |
| KPI 计算与环比 | ✅ | 2024-09-23 | 计算 4 项核心 KPI，并对比上一周数据生成变动幅度 | `src/lib/utils.ts`、`src/components/dashboard/kpi-grid.tsx` |
| 智能筛选面板 | ✅ | 2025-10-06 | 筛选功能集成到设置板块，取消弹窗设计，改为内联展示；包含四个核心维度（保单年度、周序号、三级机构、业务类型）；保单年度采用横向点选按钮；周序号改为下拉框单选，支持全部/最新一周/最近4周/最近12周快捷选项及具体周选择；三级机构分两行展示（成都机构6个、异地机构7个），支持成都机构/异地机构快捷选择、全选、反选；**业务类型基于 `business_type_category` 字段**（非 `insurance_type`），采用双列网格多选布局，支持全选、反选；顶部设置确认和取消按钮，筛选采用草稿模式（修改后需点击"应用"才生效）；新增 `businessTypes` 字段到 `FilterOptions` 和 `Filters` 类型，在 `DataContext` 中实现提取和筛选逻辑 | `src/components/dashboard/settings-menu.tsx`、`src/lib/types.ts`、`src/contexts/data-context.tsx`、`src/lib/data.ts`、`src/components/dashboard/top-filters.tsx`（保留备用） |
| 图表展示能力 | ✅ | 2025-10-06 | 新增"最近12周趋势对比图"，柱状限定绝对值指标、折线限定率值/占比指标，并继承占比图的维度取值筛选；支持周序号多选时仅趋势洞察执行多周分析，其余图表与 KPI 默认取最新周；占比图支持13个维度切换（客户类别、三级机构、业务类型等），内/外环指标自由组合；条形对比图支持13维度×15指标交叉分析，自动缩放极值；费用结余图基于14%基准线分析；所有图表采用麦肯锡金字塔原理，核心观点在标题，说明仅保留计算逻辑；趋势洞察板块柱状图颜色基于满期边际贡献率动态计算，去除网格线；**所有柱状图和条形图必须显示数值标签**，标签不触碰坐标轴，必要时压缩图表尺寸确保标签完整显示，支持正负值智能定位（负值标签显示在条形左侧）；维度控制区的“查看数据”与 AI 深度分析按钮按与筛选选项平行的列布局呈现，复制数据按钮改为仅在表格视图顶部提供以保持操作区简洁；率值类输出统一保留两位小数 | `src/components/dashboard/customer-performance.tsx`、`src/components/dashboard/weekly-trend.tsx`、`src/components/dashboard/comparison-analysis.tsx`、`src/components/dashboard/main-chart.tsx`、`src/lib/color-scale.ts` |
| 板块设置优化 | ✅ | 2025-10-06 | 新增"设置"板块作为首个板块，整合数据导入/导出、筛选配置等功能，让其他板块更聚焦分析任务；设置板块采用Excel风格多级菜单，分为数据管理、智能筛选、通知、个性化四个一级分类，点击展开对应二级选项；主题设置支持浅色/深色/跟随系统三种模式选择（深色和跟随系统暂未实现），设置板块描述文字已移除以保持简洁 | `src/components/dashboard/header.tsx`、`src/app/page.tsx`、`src/components/dashboard/settings-menu.tsx`、`src/components/dashboard/theme-settings.tsx` |
| 经营概览板块优化 | ✅ | 2025-10-05 | KPI看板标题基于本周与上周对比生成动态洞察（恶化/改善/稳定），删除多余板块描述；新增AI恶化分析组件，当检测到满期赔付率或费用率恶化时，按业务类型→三级机构→终端来源→风险评分顺序下钻分析恶化维度，并针对满期赔付率恶化进一步分解为出险率和案均赔款变化；**重构KPI展示为4行矩阵布局**：移除下钻交互，改为核心KPI+二级指标平铺展示（签单保费行含满期保费/保单件数/单均保费，满期赔付率行含已报告赔款/案均赔款/满期出险率，费用率行含费用金额/单均费用，满期边际贡献率行含变动成本率/满期边际贡献额/**终极边际贡献额**）；所有指标统一显示环比变化（变化百分比+绝对值）；核心KPI与二级指标采用固定高度布局确保垂直对齐一致；**核心与二级卡片按行共享主题色并轻微区别于其他行**；核心KPI新增绝对变化值展示（金额转万、率值以pp），AI 归因覆盖签单保费/满期赔付率/费用率恶化，并提供“选择分析板块”按钮支持后续模块扩展 | `src/components/dashboard/kpi-grid.tsx`、`src/components/dashboard/kpi-metric-card.tsx`、`src/components/dashboard/ai-deterioration-analysis.tsx` |
| 视觉设计体系 | ✅ | 2025-10-06 | 全面采用 Apple 官网风格：SF Pro 字体、柔和渐变背景与玻璃质感卡片，组件/交互维持原功能；统一各板块底层背景为 `bg-white/80 + border-white/60`；移除/替换装饰性蓝/红/黄/绿及其渐变，保留其仅用于“满期边际贡献率”状态映射 | `src/app/page.tsx`、`src/app/globals.css`、`src/components/ui/*`、`src/components/dashboard/*` |
| 数据导出 | ✅ | 2024-10-05 | 导出当前筛选结果为 CSV，并在空数据时给出反馈 | `src/lib/csv.ts`、`src/app/page.tsx` |

## 进行中 / 待办
- [ ] 扩展 KPI 至 PRD 规划的 16 项，同时完善 `src/components/dashboard/kpi-grid.tsx` 与 `src/lib/utils.ts` 的计算与展示。
- [ ] 增补筛选维度：`renewal_status`、`vehicle_insurance_grade`、`highway_risk_grade`、`terminal_source` 等尚未接入 `Filters` 类型及 UI。
- [ ] 提供 CSV 模板下载入口（README 已描述但尚无实际下载链接）。
- [ ] 建立 Vitest / React Testing Library 基础测试与数据夹具，补齐自动化验证。
- [ ] 引入 Web Worker 或流式解析，避免大文件解析阻塞主线程（PRD 性能条目）。
- [ ] 完成同比/自定义对比分析与图表联动，目前仅支持“上一周”环比。

## 风险与阻塞
- 大体量 CSV 解析仍在主线程执行，需关注页面卡顿与浏览器崩溃风险。
- 缺乏端到端/视觉回归测试，回归验证完全依赖人工。
- Genkit 相关的智能搜索未启用，如后续恢复需重新梳理需求与权限。

## 已移除 / 待清理
- `src/ai/flows/predictive-filter-suggestions.ts` 已标注“即将移除”，AI 预测筛选功能暂未上线。
- 样例文件 `2025保单第38周变动成本明细表.csv` 已从仓库删除，保留方式改为本地脱敏数据；更新 `public/data` 结构时需同步 README。

## 文档同步要求
- 每次功能上线或调整后，务必同时更新 `README.md`、`prd.md` 及本文件，确保描述与代码一致。
- 在 `开发进度.md` 中保持 ✅ / 🚧 / ⏸ 状态标记，并注明未完成或已淘汰能力。
- PR 中提醒评审关注文档是否同步，避免错漏。
